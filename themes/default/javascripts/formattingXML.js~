$(document).ready(function() {

   // UV-plugin & XML. Siirtää sivunvaihtotagit samalle tasolle, sijoittaa kunkin sivun elementit divin sisään,
   // asettaa ensimmäisen sivun näkyville, piilottaa muut.
   $('#transcr').load(function() {

     $('#transcr').contents().find('p').each(function() {
 
        if ($(this).children('.pb') && $(this).children('.pb').length == 1) {
	   
	   var child = $(this).find('.pb');
           var content = $(this).html().split(child[0].outerHTML);
           $(this).replaceWith('<p xmlns="http://www.w3.org/1999/xhtml">' + 
           content[0] + '</p>' + child[0].outerHTML + '<p xmlns="http://www.w3.org/1999/xhtml">'
           + content[1] + '</p>');
        }

        if ($(this).children('.pb') && $(this).children('.pb').length > 1) {

	   var paragraphs = [];
	   var div = $('<div xmlns="http://www.w3.org/1999/xhtml"></div');

	   $(this).find('.pb').each(function() {	

	        var thisIndex = $(this).parent().html().indexOf($(this)[0].outerHTML) + $(this)[0].outerHTML.length;

		if ($(this).nextAll(".pb").length) {
		    var nextIndex = $(this).parent().html().indexOf($(this).nextAll('.pb').first()[0].outerHTML);
		    var subst = $(this).parent().html().substring(thisIndex, nextIndex);
	            paragraphs.push($(this)[0].outerHTML);
		    paragraphs.push(subst);
                } else {
		    var subst = $(this).parent().html().substring(thisIndex, $(this).parent().html().length);
	            paragraphs.push($(this)[0].outerHTML);
		    paragraphs.push(subst);
                }
           }); 

	   $.each(paragraphs, function() {
		if (this.indexOf('pb lna') == -1) {
		   div.append('<p xmlns="http://www.w3.org/1999/xhtml">' + this + '</p>')
		} else {
		   div.append(this);
		}
	   });

	   var content = $(this).html().split($(this).find('.pb:eq(0)')[0].outerHTML);
	   $(this).html(content[0]);
	   $(this).after(div.children());
	      
        }


     });

    $('#transcr').contents().find('.pb').each(function() {
       if ($(this).nextUntil('.pb')) {
           $(this).nextUntil('.pb').andSelf().wrapAll('<div xmlns="http://www.w3.org/1999/xhtml" class="page"></div>');
       } else {
           $(this).nextAll('p').andSelf().wrapAll('<div xmlns="http://www.w3.org/1999/xhtml" class="page"></div>');
       }
     });

    $('#transcr').contents().find('.page:eq(0)').show();
    $('#transcr').contents().find('.page').not('.page:eq(0)').hide();
    $('#transcr').contents().find('.pb').hide();

   });

  // Käsintehty viewer & XML. Siirtää sivunvaihtotagit samalle tasolle, sijoittaa kunkin sivun elementit divin sisään,
   // asettaa ensimmäisen sivun näkyville, piilottaa muut.
   $('#transcr2').load(function() {

     $('#transcr2').contents().find('p').each(function() {
 
        if ($(this).children('.pb') && $(this).children('.pb').length == 1) {
	   
	   var child = $(this).find('.pb');
           var content = $(this).html().split(child[0].outerHTML);
           $(this).replaceWith('<p xmlns="http://www.w3.org/1999/xhtml">' + 
           content[0] + '</p>' + child[0].outerHTML + '<p xmlns="http://www.w3.org/1999/xhtml">'
           + content[1] + '</p>');
        }

        if ($(this).children('.pb') && $(this).children('.pb').length > 1) {

	   var paragraphs = [];
	   var div = $('<div xmlns="http://www.w3.org/1999/xhtml"></div');

	   $(this).find('.pb').each(function() {	

	        var thisIndex = $(this).parent().html().indexOf($(this)[0].outerHTML) + $(this)[0].outerHTML.length;

		if ($(this).nextAll(".pb").length) {
		    var nextIndex = $(this).parent().html().indexOf($(this).nextAll('.pb').first()[0].outerHTML);
		    var subst = $(this).parent().html().substring(thisIndex, nextIndex);
	            paragraphs.push($(this)[0].outerHTML);
		    paragraphs.push(subst);
                } else {
		    var subst = $(this).parent().html().substring(thisIndex, $(this).parent().html().length);
	            paragraphs.push($(this)[0].outerHTML);
		    paragraphs.push(subst);
                }
           }); 

	   $.each(paragraphs, function() {
		if (this.indexOf('pb lna') == -1) {
		   div.append('<p xmlns="http://www.w3.org/1999/xhtml">' + this + '</p>')
		} else {
		   div.append(this);
		}
	   });

	   var content = $(this).html().split($(this).find('.pb:eq(0)')[0].outerHTML);
	   $(this).html(content[0]);
	   $(this).after(div.children());
	      
        }

     });

    $('#transcr2').contents().find('.pb').each(function() {
       if ($(this).nextUntil('.pb')) {
           $(this).nextUntil('.pb').andSelf().wrapAll('<div xmlns="http://www.w3.org/1999/xhtml" class="page"></div>');
       } else {
           $(this).nextAll('p').andSelf().wrapAll('<div xmlns="http://www.w3.org/1999/xhtml" class="page"></div>');
       }
     });

    $('#transcr2').contents().find('.page:eq(0)').show();
    $('#transcr2').contents().find('.page').not('.page:eq(0)').hide();
    $('#transcr2').contents().find('.pb').hide();
   });

});
